<!DOCTYPE html>
<html>
<head>
  <title>Global Governance & Compliance Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body { 
      margin: 0; 
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: #f8f9fa; 
      overflow-x: hidden; 
    }

    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      padding: 0 32px;
      z-index: 2000;
      border-bottom: 3px solid #00FFC2;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-container img {
      height: 45px;
      filter: drop-shadow(0 2px 8px rgba(0, 255, 194, 0.3));
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      color: #FFFFFF;
      letter-spacing: 0.5px;
    }

    .nav-actions {
      margin-left: auto;
      display: flex;
      gap: 16px;
    }

    .nav-btn {
      background: linear-gradient(135deg, #00FFC2 0%, #008F6A 100%);
      color: #000000;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0, 255, 194, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .nav-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 255, 194, 0.5);
    }

    .nav-btn:disabled {
      background: #71758A;
      cursor: not-allowed;
      opacity: 0.5;
      box-shadow: none;
    }

    .nav-btn.back-btn {
      background: linear-gradient(135deg, #6666CC 0%, #4d4d99 100%);
      color: #FFFFFF;
      box-shadow: 0 4px 12px rgba(102, 102, 204, 0.3);
    }

    .nav-btn.back-btn:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(102, 102, 204, 0.5);
    }

    .page-content {
  margin-top: 70px;
  height: calc(100vh - 70px);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

    
    .top-section {
  background: linear-gradient(135deg, #FFFFFF 0%, #f8f9fa 100%);
  border: 3px solid #00FFC2;
  border-radius: 18px;
  margin: 8px 24px 8px 24px;   /* ‚¨Ö tighter */
  padding: 14px 20px;         /* ‚¨Ö tighter */
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
}


    h1 { 
  margin: 0 0 12px 0;
  color: #E6006E; 
  font-size: 22px;          /* ‚¨Ö smaller */
  font-weight: 700;
  letter-spacing: -0.4px;
}


    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 14px;
      margin-bottom: 0;
    }

    .metric-box {
  background: #FFFFFF;
  border: 2px solid #008F6A;
  border-radius: 12px;
  padding: 10px 8px;        /* ‚¨Ö reduced */
  text-align: center;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}


    .metric-box:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 143, 106, 0.2);
      border-color: #00FFC2;
    }

    .metric-icon {
  font-size: 24px;          /* ‚¨Ö reduced */
  margin-bottom: 4px;
}

.metric-value {
  font-size: 18px;          /* ‚¨Ö reduced */
  font-weight: 800;
  margin-bottom: 2px;
}

.metric-label {
  font-size: 11px;
}


    #map {
  flex: 1;
  height: auto !important;
  margin: 0 24px 16px 24px;  /* ‚¨Ö less bottom margin */
  border-radius: 20px;
  border: 3px solid #008F6A;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
}


    .label {
      background: linear-gradient(135deg, #008F6A 0%, #00FFC2 100%);
      color: #000000;
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 13px;
      white-space: nowrap;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0, 143, 106, 0.4);
      letter-spacing: 0.3px;
    }

    .back-btn {
      position: absolute;
      top: 24px;
      left: 24px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.85);
      color: #FFFFFF;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      display: none;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      border: 2px solid #00FFC2;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(0, 255, 194, 0.95);
      color: #000000;
      transform: translateX(-4px);
    }

    #detailView {
      display: none;
      margin: 0 24px 24px 24px;
      border-radius: 20px;
      border: 3px solid #008F6A;
      padding: 32px;
      overflow-y: auto;
      box-sizing: border-box;
      flex: 1 1 auto;
      background: #FFFFFF;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    }

    h2 { 
      margin-top: 0; 
      color: #E6006E;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.5px;
      padding-bottom: 16px;
      border-bottom: 3px solid #00FFC2;
    }

    h3 { 
      margin-top: 40px; 
      color: #000000;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      padding-bottom: 12px;
      border-bottom: 2px solid #B3AEB9;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      border: 2px solid #008F6A;
      border-radius: 16px;
      padding: 20px;
      font-size: 14px;
      background: linear-gradient(135deg, #FFFFFF 0%, #f8f9fa 100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      color: #71758A;
      font-weight: 600;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(0, 143, 106, 0.2);
      border-color: #00FFC2;
    }

    .card b {
      display: block;
      margin-top: 10px;
      font-size: 24px;
      color: #000000;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .compliance-section {
      margin-top: 40px;
      border-top: 3px solid #00FFC2;
      padding-top: 32px;
    }

    .compliance-section h3 {
      color: #000000;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      border-bottom: none;
    }

    .compliance-sites-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .compliance-site-card {
      background: linear-gradient(135deg, #FFFFFF 0%, #f8f9fa 100%);
      border: 3px solid #008F6A;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .compliance-site-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 143, 106, 0.15);
    }

    .compliance-site-card h4 {
      color: #000000;
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      letter-spacing: 0.3px;
    }

    .compliance-score {
      background: linear-gradient(135deg, #6666CC 0%, #4d4d99 100%);
      color: #FFFFFF;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 15px;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(102, 102, 204, 0.3);
      letter-spacing: 0.5px;
    }

    .compliance-chart-container {
      height: 200px;
      position: relative;
    }

    .drawer {
      position: fixed;
      right: -680px;
      top: 0;
      width: 620px;
      height: 100%;
      background: linear-gradient(135deg, #FFFFFF 0%, #f8f9fa 100%);
      box-shadow: -12px 0 48px rgba(0, 0, 0, 0.3);
      padding: 40px;
      overflow-y: auto;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 3000;
      overflow-x: hidden;
      border-left: 4px solid #00FFC2;
    }

    .drawer.open {
      right: 0;
    }

    .drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      z-index: 2999;
      backdrop-filter: blur(4px);
    }

    .drawer-overlay.active {
      display: block;
    }

    .drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 3px solid #00FFC2;
    }

    .drawer-header h2 {
      color: #000000;
      font-size: 26px;
      font-weight: 700;
      margin: 0;
      border: none;
      padding: 0;
      letter-spacing: -0.5px;
    }

    .close-btn {
      background: linear-gradient(135deg, #E6006E 0%, #b1004b 100%);
      color: #FFFFFF;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(230, 0, 110, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .close-btn:hover {
      background: linear-gradient(135deg, #b1004b 0%, #E6006E 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 24px rgba(230, 0, 110, 0.6);
    }

    .section {
      margin-bottom: 32px;
    }

    .section h3 {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border-bottom: 2px solid #B3AEB9;
      padding-bottom: 10px;
    }

    .section.done h3 { color: #008F6A; border-bottom-color: #00FFC2; }
    .section.progress h3 { color: #FFCC00; border-bottom-color: #FFCC00; }
    .section.pending h3 { color: #E6006E; border-bottom-color: #E6006E; }

    .item {
      background: #FFFFFF;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 12px;
      border-left: 5px solid #B3AEB9;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .item:hover {
      background: #f8f9fa;
      transform: translateX(6px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .section.done .item { border-left-color: #00FFC2; }
    .section.progress .item { border-left-color: #FFCC00; }
    .section.pending .item { border-left-color: #E6006E; }

    .item strong {
      display: block;
      color: #000000;
      margin-bottom: 6px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .item small {
      color: #71758A;
      font-size: 13px;
      font-weight: 600;
    }

    .category-badge {
      display: inline-block;
      padding: 5px 14px;
      border-radius: 14px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-top: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .badge-facility { background: #00FFC2; color: #000000; }
    .badge-fire { background: #E6006E; color: #FFFFFF; }
    .badge-statutory { background: #008F6A; color: #FFFFFF; }
    .badge-vendor { background: #FFCC00; color: #000000; }
    .badge-environment { background: #6666CC; color: #FFFFFF; }
    .badge-security { background: #71758A; color: #FFFFFF; }

    .leaflet-control-attribution,
    .leaflet-control-zoom,
    .leaflet-control,
    .leaflet-bottom,
    .leaflet-right,
    .leaflet-top {
      display: none !important;
      visibility: hidden !important;
    }
    
    #map .leaflet-control-container .leaflet-bottom.leaflet-right {
      display: none !important;
    }

    html, body {
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .page-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.page-main-inner {
  flex: 1;
  display: flex;
  min-height: 0;
}

#map {
  flex: 1;
  height: auto !important;
  margin: 0 24px 24px 24px;
}


    html, body, .page-main {
      height: 100%;
    }

    .leaflet-container {
      height: 100% !important;
    }
  </style>
</head>

<body>

<div class="top-nav">
  <div class="logo-container">
    <img src="ss.png" alt="Company Logo">
    <span class="logo-text">GOVERNANCE DASHBOARD</span>
  </div>
  <div class="nav-actions">
    <button class="nav-btn" id="homeBtn" onclick="handleHomeClick()">üè† Home</button>
    <button class="nav-btn back-btn" id="navBackBtn" onclick="handleBackClick()" disabled>‚Üê Back</button>
  </div>
</div>

<div class="page-content">
  <div class="top-section" id="topSection">
    <h1>Global Real Estate Footprint and Facility Management Overview</h1>
    
    <div class="metrics-grid">
      <div class="metric-box">
        <div class="metric-icon">üìç</div>
        <div class="metric-value" id="totalSites">11</div>
        <div class="metric-label">Sites</div>
      </div>
      <div class="metric-box">
        <div class="metric-icon">üè¢</div>
        <div class="metric-value" id="totalRealEstate">184.9K</div>
        <div class="metric-label">Real Estate in Sq Feet</div>
      </div>
      <div class="metric-box">
        <div class="metric-icon">üë•</div>
        <div class="metric-value" id="totalPeople">2116</div>
        <div class="metric-label">Employees</div>
      </div>
      <div class="metric-box">
        <div class="metric-icon">üíµ</div>
        <div class="metric-value" id="totalOpex">4M</div>
        <div class="metric-label">OpEx</div>
      </div>
      <div class="metric-box">
        <div class="metric-icon">üí∞</div>
        <div class="metric-value" id="totalCapex">--</div>
        <div class="metric-label">CapEx</div>
      </div>
      <div class="metric-box">
        <div class="metric-icon">üíé</div>
        <div class="metric-value" id="assetValue">--</div>
        <div class="metric-label">Asset Value</div>
      </div>
      <div class="metric-box">
        <div class="metric-icon">üìã</div>
        <div class="metric-value" id="compliance">--</div>
        <div class="metric-label">Compliance</div>
      </div>
    </div>
  </div>

  <div class="page-main">
    <div class="page-main-inner">
      <div class="back-btn" id="backBtn">‚Üê Back</div>
      <div id="map"></div>

      <div id="detailView">
        <h2 id="detailTitle"></h2>

        <h3>Core Footprint</h3>
        <div class="grid" id="coreGrid"></div>

        <h3>Cost Efficiency</h3>
        <div class="grid" id="efficiencyGrid"></div>

        <h3>Financials</h3>
        <div class="grid" id="financialGrid"></div>

        <div class="compliance-section">
          <h3>üìä Compliance Overview</h3>
          <div class="compliance-sites-container" id="complianceSitesContainer"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="drawer-overlay" id="overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <h2 id="drawerTitle"></h2>
    <button class="close-btn" onclick="closeDrawer()">‚úï Close</button>
  </div>

  <div class="section done">
    <h3>‚úÖ Completed</h3>
    <div id="done"></div>
  </div>

  <div class="section progress">
    <h3>‚ö†Ô∏è In Progress</h3>
    <div id="progress"></div>
  </div>

  <div class="section pending">
    <h3>‚ùå Pending</h3>
    <div id="notdone"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================= GOOGLE SHEETS CONFIG ================= */
const SHEET_ID = "14Bz3QibO5MWiOjaF-pvSfDs3enW5Nd6R";
const SHEET_NAME = "Sheet1";

/* ================= MAP INIT ================= */
let map = L.map("map").setView([20, 0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

setTimeout(() => {
  map.invalidateSize(true);
}, 200);


const backBtn = document.getElementById("backBtn");
const detailView = document.getElementById("detailView");
const detailTitle = document.getElementById("detailTitle");

/* ================= STATE ================= */
let currentView = "world";
let currentCountry = null;

/* ================= STATIC MAP DATA ================= */
const countries = {
  "United States": { lat:37, lng:-95, zoom:4 },
  "Mexico": { lat:23, lng:-102, zoom:5 },
  "Ireland": { lat:53, lng:-8, zoom:6 },
  "United Kingdom": { lat:55, lng:-3, zoom:6 },
  "Poland": { lat:52, lng:19, zoom:6 },
  "Romania": { lat:45.9, lng:24.9, zoom:6 },
  "India": { lat:21, lng:78, zoom:5 },
  "Malaysia": { lat:4, lng:102, zoom:6 },
  "Philippines": { lat:13, lng:122, zoom:6 },
  "Singapore": { lat:1.3, lng:103.8, zoom:7 },
  "Australia": { lat:-25, lng:133, zoom:4 }
};

const cities = {
  "India": [
    ["Vadodara",22.31,73.18],
    ["Bengaluru",12.97,77.59],
    ["Hyderabad",17.38,78.48],
    ["Chennai",13.08,80.27],
    ["Pune",18.52,73.85]
  ],
  "United States": [
    ["Atlanta",33.75,-84.39],
    ["Austin",30.27,-97.74],
    ["Basking Ridge",40.71,-74.55],
    ["Charlotte",35.22,-80.84],
    ["Chicago",41.88,-87.63],
    ["Dallas",32.78,-96.8],
    ["Folsom",38.68,-121.18],
    ["Glen Allen",37.66,-77.5],
    ["Irvine",33.68,-117.83],
    ["Jersey City",40.72,-74.07],
    ["Minneapolis",44.97,-93.26],
    ["Pleasanton",37.66,-121.87],
    ["Raleigh",35.78,-78.64],
    ["Redmond",47.67,-122.12],
    ["San Diego",32.71,-117.16],
    ["San Francisco",37.77,-122.42],
    ["San Jose",37.33,-121.89],
    ["Tampa",27.95,-82.46]
  ],
  "Philippines": [
    ["Manila",14.6,120.98],
    ["Cebu City",10.31,123.89],
    ["Davao City",7.19,125.45]
  ],
  "Poland": [
    ["Krakow",50.06,19.94],
    ["Warsaw",52.23,21.01]
  ]
};

/* ================= GOOGLE SHEETS LOAD ================= */
const cityData = {};
const NA = v => (v === null || v === undefined || v === "" ? "NA" : v);

fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}`)
  .then(r => r.text())
  .then(t => {
    const json = JSON.parse(t.substr(47).slice(0, -2));
    json.table.rows.forEach(r => {
      const city = r.c[0]?.v;
      if (!city) return;

      cityData[city] = {
        realEstate: r.c[1]?.v,
        opex: r.c[2]?.v,
        capex: r.c[3]?.v,
        headcount: r.c[4]?.v,
        seats: r.c[5]?.v,
        perHead: r.c[6]?.v,
        perSqft: r.c[7]?.v,
        country: r.c[8]?.v,
        compliance: r.c[9]?.v,
        fiveYear: r.c[10]?.v,
        annualCapex: r.c[11]?.v,
        annualCost: r.c[12]?.v,
        annualPerSqft: r.c[13]?.v,
        annualPerHead: r.c[14]?.v,
        dollars: r.c[15]?.v
      };
    });
    
    updateHeaderMetrics();
  });

/* ================= HEADER METRICS ================= */
function updateHeaderMetrics() {
  const sites = Object.keys(cityData).length;
  let totalRE = 0, totalOpex = 0, totalCapex = 0, totalPeople = 0;
  
  Object.values(cityData).forEach(d => {
    if (d.realEstate && !isNaN(d.realEstate)) totalRE += parseFloat(d.realEstate);
    if (d.opex && !isNaN(d.opex)) totalOpex += parseFloat(d.opex);
    if (d.capex && !isNaN(d.capex)) totalCapex += parseFloat(d.capex);
    if (d.headcount && !isNaN(d.headcount)) totalPeople += parseFloat(d.headcount);
  });
  
  document.getElementById('totalSites').innerText = sites;
  document.getElementById('totalRealEstate').innerText = totalRE > 0 ? (totalRE/1000).toFixed(1) + 'K' : '--';
  document.getElementById('totalPeople').innerText = totalPeople > 0 ? totalPeople.toLocaleString() : '--';
  document.getElementById('totalOpex').innerText = totalOpex > 0 ? (totalOpex/1000000).toFixed(1) + 'M' : '--';
  document.getElementById('totalCapex').innerText = totalCapex > 0 ? '‚Çπ' + totalCapex.toLocaleString() : '--';
}

/* ================= NAVIGATION ================= */
let countryMarkers = [];
let cityMarkers = [];

function clearMarkers(list) {
  list.forEach(m => map.removeLayer(m));
  list.length = 0;
}

backBtn.onclick = () => {
  if (currentView === "city") {
    closeDetail();
    showCountry(currentCountry);
  } else if (currentView === "country") {
    showWorld();
  }
};

function showWorld() {
  setTimeout(() => {
  map.invalidateSize(true);
}, 200);


  currentView = "world";
  currentCountry = null;

  closeDetail();
  clearMarkers(countryMarkers);
  clearMarkers(cityMarkers);

  document.getElementById("topSection").style.display = "block";
  backBtn.style.display = "none";
  map.setView([20,0],2);

  Object.entries(countries).forEach(([name,c]) => {
    const m = L.marker([c.lat,c.lng])
      .addTo(map)
      .bindTooltip(name,{permanent:true,className:"label"})
      .on("click",()=> showCountry(name));
    countryMarkers.push(m);
  });

  updateNavButtons();
  setTimeout(() => map.invalidateSize(), 0);
}

function showCountry(country) {
  currentView = "country";
  currentCountry = country;

  closeDetail();
  clearMarkers(countryMarkers);
  clearMarkers(cityMarkers);

  document.getElementById("topSection").style.display = "none";
  backBtn.style.display = "block";
  map.setView(
    [countries[country].lat, countries[country].lng],
    countries[country].zoom
  );

  (cities[country] || []).forEach(city => {
  let offset = [0, 0];
  let direction = "center";

  if (city[0] === "Bengaluru") {
    offset = [-22, 0];
    direction = "left";
  }

  if (city[0] === "Chennai") {
    offset = [22, 0];
    direction = "right";
  }

  const m = L.circleMarker([city[1], city[2]], {
    radius: 8,
    color: "#008F6A",
    fillColor: "#00FFC2",
    fillOpacity: 1
  })
    .addTo(map)
    .bindTooltip(city[0], {
      permanent: true,
      className: "label",
      direction,
      offset
    })
    .on("click", () => openCity(city[0], country));

  cityMarkers.push(m);
});



  updateNavButtons();
  setTimeout(() => map.invalidateSize(), 0);
}

function openCity(city, country) {
  currentView = "city";
  currentCountry = country;

  document.getElementById("map").style.display = "none";
  detailView.style.display = "block";
  backBtn.style.display = "block";

  detailTitle.innerText = city;
  const d = cityData[city] || {};

  document.getElementById("coreGrid").innerHTML = `
    <div class="card">üè¢ Real Estate<b>${NA(d.realEstate)}</b></div>
    <div class="card">üë• Employees<b>${NA(d.headcount)}</b></div>
    <div class="card">üí∫ Seats<b>${NA(d.seats)}</b></div>
    <div class="card">üåç Country<b>${NA(d.country)}</b></div>
  `;

  document.getElementById("efficiencyGrid").innerHTML = `
    <div class="card">Per Head<b>${NA(d.perHead)}</b></div>
    <div class="card">Per Sqft<b>${NA(d.perSqft)}</b></div>
    <div class="card">Annual / Head<b>${NA(d.annualPerHead)}</b></div>
    <div class="card">Annual / Sqft<b>${NA(d.annualPerSqft)}</b></div>
  `;

  document.getElementById("financialGrid").innerHTML = `
    <div class="card">‚Çπ OpEx<b>${NA(d.opex)}</b></div>
    <div class="card">‚Çπ CapEx<b>${NA(d.capex)}</b></div>
    <div class="card">‚Çπ 5 Year Cost<b>${NA(d.fiveYear)}</b></div>
    <div class="card">$ Dollars<b>${NA(d.dollars)}</b></div>
  `;

  loadComplianceForCity(city);
  updateNavButtons();
}

function closeDetail() {
  detailView.style.display = "none";
  document.getElementById("map").style.display = "block";
  updateNavButtons();
  setTimeout(() => map.invalidateSize(), 0);
}

/* ================= TOP NAV BUTTON HANDLERS ================= */
function handleHomeClick() {
  showWorld();
}

function handleBackClick() {
  if (currentView === "city") {
    closeDetail();
    showCountry(currentCountry);
  } else if (currentView === "country") {
    showWorld();
  }
}

function updateNavButtons() {
  const navBackBtn = document.getElementById("navBackBtn");
  navBackBtn.disabled = currentView === "world";
}

/* INIT */
showWorld();

/* ================= COMPLIANCE DATA LOADING ================= */
const COMPLIANCE_SHEET_ID = "1BaIWbKdMjvro5E_IG3ceyNSRA98T-5a-";
const COMPLIANCE_GID = "1802692301";

const complianceSites = [
  { name: "Vadodara", col: 4 },
  { name: "Bangalore PBC", col: 7 },
  { name: "Chennai", col: 10 },
  { name: "Hyderabad", col: 13 },
  { name: "Pune", col: 16 },
  { name: "Bangalore RBD", col: 19 }
];

const complianceRawData = [];
let complianceDataLoaded = false;

fetch(`https://docs.google.com/spreadsheets/d/${COMPLIANCE_SHEET_ID}/gviz/tq?gid=${COMPLIANCE_GID}`)
  .then(r => r.text())
  .then(t => {
    const json = JSON.parse(t.substring(47).slice(0, -2));
    const rows = json.table.rows;

    let currentCategory = "";

    rows.forEach(r => {
      const c = r.c;
      if (!c || !c[1]?.v) return;

      if (c[0]?.v) currentCategory = c[0].v.trim();

      complianceSites.forEach(site => {
        const status = c[site.col]?.v;
        if (!status || status === "NA") return;

        complianceRawData.push({
          city: site.name,
          category: currentCategory,
          area: c[1]?.v,
          doc: c[2]?.v,
          owner: c[3]?.v,
          status: status.trim().toLowerCase()
        });
      });
    });

    complianceDataLoaded = true;
  });

function loadComplianceForCity(baseCity) {
  const container = document.getElementById("complianceSitesContainer");
  container.innerHTML = "";

  if (!complianceDataLoaded) {
    container.innerHTML = '<p style="color:#71758A;">Loading compliance data...</p>';
    setTimeout(() => loadComplianceForCity(baseCity), 500);
    return;
  }

  const matchingSites = complianceSites.filter(site => {
    if (baseCity === "Bengaluru" || baseCity === "Bangalore") {
      return site.name.startsWith("Bangalore");
    }
    return site.name === baseCity;
  });

  if (!matchingSites.length) {
    container.innerHTML = '<p style="color:#71758A;">No compliance data available.</p>';
    return;
  }

  matchingSites.forEach(site => {
    const siteData = complianceRawData.filter(r => r.city === site.name);
    if (!siteData.length) return;

    const grouped = {};
    siteData.forEach(r => {
      if (!grouped[r.category]) grouped[r.category] = { yes: 0, total: 0 };
      grouped[r.category].total++;
      if (r.status === "yes") grouped[r.category].yes++;
    });

    const overallScore = Math.round(
      (siteData.filter(r => r.status === "yes").length / siteData.length) * 100
    );

    const siteCard = document.createElement("div");
    siteCard.className = "compliance-site-card";
    siteCard.innerHTML = `
      <h4>${site.name}<span class="compliance-score">${overallScore}%</span></h4>
      <div class="compliance-chart-container"><canvas></canvas></div>
    `;
    container.appendChild(siteCard);

    const cats = Object.keys(grouped);
    const values = cats.map(c =>
      Math.round((grouped[c].yes / grouped[c].total) * 100)
    );

    new Chart(siteCard.querySelector("canvas"), {
      type: "bar",
      data: {
        labels: cats,
        datasets: [{ data: values, backgroundColor: "#008F6A", borderRadius: 6 }]
      },
      options: {
        indexAxis: "y",
        plugins: { legend: { display: false } },
        scales: { x: { max: 100 } }
      }
    });
  });
}

function closeDrawer() {
  document.getElementById("drawer").classList.remove("open");
  document.getElementById("overlay").classList.remove("active");
}
</script>

</body>
</html>
